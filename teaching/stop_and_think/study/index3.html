<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Stop + Think</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2em;
      background: #ffffff;
    }
    textarea {
      margin-top: 1em;
      width: 80ch;
      height: 100px;
    }
    .answer {
      color: green;
      font-size: 0.9em;
    }
    .question-box {
      width: 80ch;
    }
    .navigation {
      margin-top: 1.5em;
    }
    button {
      margin-right: 10px;
    }
  </style>
  <script src="stop_and_think.js"></script>
</head>
<body>

  <div class="question-box" id="question-box"></div>
  <br>
  <div class="navigation" id="nav"></div>
  <textarea id="response-box" placeholder="Type your response here..."></textarea>

  <details id="answer-box" style="margin-top: 1em;">
    <summary style="cursor: pointer; color: #565858; background-color: #ffffff; margin-bottom: 10px;">
      <span style="font-size: 10pt;">Compare your response</span>
    </summary>
    <div style="border: thin solid #F1F3F4; margin-bottom: 10px; padding: 5px 15px; width: 75ch;">
      <p class="answer" id="answer-text"><span></span></p>
    </div>
  </details>


  <script>
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    function getQuestionSequence() {
      const qList = getQueryParam("q");
      return qList ? qList.split(",").map(n => parseInt(n.trim(), 10)) : [];
    }

    function getCurrentIndex() {
      const index = getQueryParam("i");
      return index ? parseInt(index, 10) : 0;
    }

    function renderQuestion() {
      const sequence = getQuestionSequence();
      const currentIndex = getCurrentIndex();
      const qNum = sequence[currentIndex];

      //const entry = data.find(q => q.number === qNum);
      const entry = window.stopThinkQuestions.find(q => q.number === qNum);

      const questionBox = document.getElementById("question-box");
      const answerBox = document.getElementById("answer-box");
      const answerText = document.getElementById("answer-text");
      const responseBox = document.getElementById("response-box");

      if (!entry) {
        questionBox.innerHTML = `<strong>Question not found. Check your q list.</strong>`;
        answerBox.style.display = "none";
        return;
      }

      const key = `stopthink_q_${entry.number}`;
      const saved = localStorage.getItem(key) || "";

      questionBox.innerHTML = `
        <strong><span style="font-size: 12pt;">
          <strong><span style="color: #ba372a;">STOP</span>
            <span style="color: #565858ff;">+</span>
            <span style="color: #377437ff;">THINK</span>: </strong>
          ${entry.question} (${entry.number})
        </span></strong>`;

      answerText.innerText = entry.answer;
      responseBox.value = saved;

      responseBox.addEventListener("input", () => {
        localStorage.setItem(key, responseBox.value);
      });

      renderNav(sequence, currentIndex);
    }

    function renderNav(sequence, index) {
      const nav = document.getElementById("nav");
      nav.innerHTML = "";

        const nextIndex = (index + 1) % sequence.length;
        const nextNum = sequence[nextIndex];

        const nextBtn = document.createElement("button");
        nextBtn.textContent = `Go to Question ${nextIndex + 1} of ${sequence.length}`;
        //nextBtn.textContent = `Go to Question ${nextNum}`;
        nextBtn.onclick = () => {
        const base = window.location.pathname;
        const params = new URLSearchParams();
        params.set("q", sequence.join(","));
        params.set("i", nextIndex);
        window.location.href = `${base}?${params.toString()}`;
        };
        nav.appendChild(nextBtn);

      const downloadBtn = document.createElement("button");
      downloadBtn.textContent = "Download All My Answers";
      downloadBtn.onclick = downloadAnswers;
      nav.appendChild(downloadBtn);

      const showBtn = document.createElement("button");
      showBtn.textContent = "Show My Answers So Far";
      showBtn.onclick = showAnswersInline;
      nav.appendChild(showBtn);

    }

    function downloadAnswers() {
        const sequence = getQuestionSequence();
        let output = "";

        sequence.forEach(num => {
            const card = window.stopThinkQuestions.find(q => q.number === num);
            if (card) {
            const key = `stopthink_q_${card.number}`;
            const answer = localStorage.getItem(key) || "";
            output += `Question ${card.number}: ${card.question}\n\nME: ${answer}\n\n`;
            }
        });

        const blob = new Blob([output], { type: "text/plain" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "stop-think-answers.txt";
        a.click();
    }

    function showAnswersInline() {
        let output = "";
        const sequence = getQuestionSequence();

        sequence.forEach(num => {
            const card = window.stopThinkQuestions.find(q => q.number === num);
            if (card) {
            const key = `stopthink_q_${card.number}`;
            const answer = localStorage.getItem(key) || "";
            output += `Question ${card.number}: ${card.question}\n\n${answer}\n\n\n`;
            }
        });

        let outputDiv = document.getElementById("inline-answers");
        if (!outputDiv) {
            outputDiv = document.createElement("div");
            outputDiv.id = "inline-answers";
            outputDiv.style.marginTop = "2em";
            outputDiv.innerHTML = `<h3>Your Answers So Far:</h3>`;
            const pre = document.createElement("pre");
            pre.style.border = "1px solid #ccc";
            pre.style.padding = "10px";
            pre.style.backgroundColor = "#f9f9f9";
            pre.style.whiteSpace = "pre-wrap";
            pre.id = "answers-text";
            outputDiv.appendChild(pre);
            document.body.appendChild(outputDiv);
        }

        document.getElementById("answers-text").textContent = output;
        }


    window.addEventListener("load", renderQuestion);
  </script>

</body>
</html>
